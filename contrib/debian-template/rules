#!/usr/bin/make -f

include /usr/share/dpkg/architecture.mk
include /usr/share/dpkg/buildflags.mk
include /usr/share/dpkg/pkg-info.mk

export DEB_BUILD_MAINT_OPTIONS = hardening=+all optimize=+lto

OFI_NCCL_PREFIX=/opt/amazon/ofi-nccl

override_dh_missing:
	find debian/ -name *.la -delete
	mkdir -p debian/libnccl-ofi/etc/ld.so.conf.d && echo "${OFI_NCCL_PREFIX}/lib" >> debian/libnccl-ofi/etc/ld.so.conf.d/100_ofinccl.conf
	dh_missing --fail-missing

override_dh_shlibdeps:
	dh_shlibdeps --dpkg-shlibdeps-params=--ignore-missing-info

override_dh_auto_configure:
	dh_auto_configure -- \
		--with-libfabric=/opt/amazon/efa \
		--prefix=${OFI_NCCL_PREFIX} \
		--libdir=${OFI_NCCL_PREFIX}/lib \
		--enable-platform-aws \
		--with-cuda=/usr/local/cuda \
		--enable-cudart-dynamic \
		--disable-tests \
		--without-lttng \
		--without-valgrind \
		--disable-werror

#%:
#	dh $@
# this is a hack to work around efa-installer diamond dependency with
# efa-config/libfabric-aws and should be removed.
%:
	LD_LIBRARY_PATH=/opt/amazon/efa/lib:${LD_LIBRARY_PATH} dh $@
